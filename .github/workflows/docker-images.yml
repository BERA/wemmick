name: Build and Deploy Docker Image CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout project
        uses: actions/checkout@v2
      - name: login to Dockerhub
        uses: azure/docker-login@v1
        with:
          login-server: index.docker.io
          registry: registry.hub.docker.com
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: build and push
        run: |
          CREATED=$(date --rfc-3339=date)
          GE_VER=$(grep "^great_expectations" requirements-base.txt | cut -d'=' -f3-)
          REVISION=${GITHUB_REF#refs/heads/}
          docker build --tag ge --target ge \
            --build-arg GE_VER=$GE_VER \
            --build-arg CREATED=$CREATED \
            --build-arg REVISION=$REVISION \
            .
          docker build --tag wemmick \
            --build-arg GE_VER=$GE_VER \
            --build-arg CREATED=$CREATED \
            --build-arg REVISION=$REVISION \
            .
          if [ $(git rev-parse --abbrev-ref HEAD) == 'main']; then
            docker tag wemmick beradev/wemmick:lastest
            docker tag ge beradev/wemmick:ge-$GE_VER
          else
            docker tag ge beradev/wemmick:ge-$REVISION
            docker tag wemmick beradev/wemmick:$REVISION
          fi
          docker images --format "{{.Repository}}:{{.Tag}}" | grep 'beradev' | xargs -n 1 docker push

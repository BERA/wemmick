name: Build and Release Docker Images

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-images:
    runs-on: ubuntu-latest
    steps:
      - name: checkout project
        uses: actions/checkout@v2
      - name: build ge
        run: |
          CREATED=$(date --rfc-3339=date)
          GE_VER=$(grep "^great_expectations" requirements-base.txt | cut -d'=' -f3-)
          REVISION=${GITHUB_REF#refs/heads/}
          docker build --tag ge --target ge \
            --build-arg GE_VER=$GE_VER \
            --build-arg CREATED=$CREATED \
            --build-arg REVISION=$REVISION \
            .
      - name: build wemmick
        run: |
          echo $CREATED
          docker build --tag wemmick \
            --build-arg GE_VER=$GE_VER \
            --build-arg CREATED=$CREATED \
            --build-arg REVISION=$REVISION \
            .
  release-images:
    runs-on: ubuntu-latest
    needs:
      build-images
    steps:
      - name: checkout project
        uses: actions/checkout@v2
      - name: login to Dockerhub
        uses: azure/docker-login@v1
        with:
          login-server: index.docker.io
          registry: registry.hub.docker.com
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          GE_VER=$(grep "^great_expectations" requirements-base.txt | cut -d'=' -f3-)
          REVISION=$(git rev-parse --abbrev-ref HEAD)
          if [ "$REVISION" == "main" ]; then
            docker tag wemmick beradev/wemmick:latest
            docker tag ge beradev/wemmick:ge-$GE_VER
          else
            docker tag ge beradev/wemmick:ge-$REVISION
            docker tag wemmick beradev/wemmick:$REVISION
          fi
         # docker images --format "{{.Repository}}:{{.Tag}}" | grep 'beradev' | xargs -n 1 docker push

